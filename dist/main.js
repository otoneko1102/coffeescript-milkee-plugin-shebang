// Generated by CoffeeScript 2.7.0
var PREFIX, addShebang, consola, fs, path, pkg, resolveSourceFile;

fs = require('fs');

path = require('path');

consola = require('consola');

pkg = require('../package.json');

PREFIX = `[${pkg.name}]`;

resolveSourceFile = function(jsFile, config) {
  var cwd, entryPath, outDir, relative, srcFile, srcRelative;
  cwd = process.cwd();
  outDir = path.resolve(cwd, config.output);
  entryPath = path.resolve(cwd, config.entry);
  try {
    if (fs.statSync(entryPath).isFile()) {
      return entryPath;
    }
  } catch (error1) {
    return null;
  }
  relative = path.relative(outDir, jsFile);
  srcRelative = relative.replace(/\.js$/, '.coffee');
  srcFile = path.join(entryPath, srcRelative);
  if (fs.existsSync(srcFile)) {
    return srcFile;
  }
  return null;
};

addShebang = function(options = {}) {
  return function(compilationResult) {
    var compiledFiles, config, error, firstLine, i, jsContent, jsFile, len, newContent, processedCount, ref, srcContent, srcFile;
    consola.info(`${PREFIX} Running...`);
    ({compiledFiles, config} = compilationResult);
    if ((ref = config.options) != null ? ref.join : void 0) {
      consola.info(`${PREFIX} Option \`join\` is enabled. Skipping shebang addition.`);
      return;
    }
    if (!(compiledFiles && compiledFiles.length > 0)) {
      consola.warn(`${PREFIX} No compiled files found.`);
      return;
    }
    processedCount = 0;
    for (i = 0, len = compiledFiles.length; i < len; i++) {
      jsFile = compiledFiles[i];
      if (!jsFile.endsWith('.js')) {
        continue;
      }
      try {
        srcFile = resolveSourceFile(jsFile, config);
        if (!srcFile) {
          continue;
        }
        srcContent = fs.readFileSync(srcFile, 'utf-8');
        firstLine = srcContent.split('\n')[0].trim();
        if (firstLine.startsWith('#!')) {
          jsContent = fs.readFileSync(jsFile, 'utf-8');
          if (!jsContent.startsWith('#!')) {
            newContent = firstLine + '\n' + jsContent;
            fs.writeFileSync(jsFile, newContent, 'utf-8');
            consola.trace(`${PREFIX} Added shebang to ${path.basename(jsFile)}: ${firstLine}`);
            processedCount++;
          }
        }
      } catch (error1) {
        error = error1;
        consola.error(`${PREFIX} Failed to process ${jsFile}:`, error);
      }
    }
    if (processedCount > 0) {
      return consola.success(`${PREFIX} Added shebang lines to ${processedCount} file(s).`);
    } else {
      return consola.info(`${PREFIX} No files needed shebang addition.`);
    }
  };
};

module.exports = addShebang;
